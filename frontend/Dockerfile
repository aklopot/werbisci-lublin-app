FROM node:20-alpine AS build

# Build arguments for versioning
ARG VERSION=dev
ARG BUILD_DATE=unknown

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .

# Ensure version.json exists (will be generated by build script)
RUN test -f public/version.json || echo "{\"version\":\"${VERSION}\",\"buildDate\":\"${BUILD_DATE}\"}" > public/version.json

RUN npm run build

FROM nginx:alpine

# Pass build args to final stage
ARG VERSION=dev
ARG BUILD_DATE=unknown

# Label the image with version information
LABEL version="${VERSION}" \
      buildDate="${BUILD_DATE}" \
      description="Werbisci Lublin App - Frontend"

COPY --from=build /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
